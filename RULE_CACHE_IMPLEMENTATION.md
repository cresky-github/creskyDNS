# Rule Cache åŠŸèƒ½å®ç°å®ŒæˆæŠ¥å‘Š

## âœ… å®ç°æ¦‚è§ˆ

å·²æˆåŠŸå®ç° `rule.cache` åŠŸèƒ½ï¼Œä¸ `domain.cache` ç»„æˆå®Œæ•´çš„ä¸¤çº§ç¼“å­˜ç³»ç»Ÿã€‚

## ğŸ“¦ å®ç°å†…å®¹

### 1. **æ–°å¢ RuleCache ç»“æ„** ([src/cache.rs](src/cache.rs))

```rust
pub struct RuleCache {
    cache: Arc<RwLock<HashMap<String, String>>>, // domain -> upstream_name
}
```

**æ ¸å¿ƒæ–¹æ³•**ï¼š
- `new()` - åˆ›å»ºè§„åˆ™ç¼“å­˜å®ä¾‹
- `get(domain)` - æŸ¥è¯¢ç¼“å­˜ï¼ˆè¿”å› upstream åç§°ï¼‰
- `insert(domain, upstream)` - å†™å…¥ç¼“å­˜
- `clear()` - æ¸…ç©ºæ‰€æœ‰ç¼“å­˜ï¼ˆreload æ—¶è°ƒç”¨ï¼‰
- `stats()` - è·å–ç»Ÿè®¡ä¿¡æ¯

### 2. **é›†æˆåˆ° DNS è§£ææµç¨‹** ([src/forwarder.rs](src/forwarder.rs))

ä¿®æ”¹ `DnsForwarder::process_request()` å®ç°ä¸‰çº§ DNS è§£æï¼š

```rust
async fn process_request(&self, request: &Message) -> Result<Message> {
    // 1ï¸âƒ£ æŸ¥è¯¢ Rule Cacheï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    if let Some(upstream_name) = rule_cache.get(domain) {
        // ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ upstreamï¼Œè·³è¿‡è§„åˆ™åŒ¹é…
    }
    
    // 2ï¸âƒ£ æŸ¥è¯¢ Domain Cacheï¼ˆç¬¬äºŒä¼˜å…ˆçº§ï¼‰
    if let Some(cached_response) = domain_cache.get(domain) {
        return Ok(cached_response); // ç›´æ¥è¿”å›ç¼“å­˜çš„ DNS å“åº”
    }
    
    // 3ï¸âƒ£ è§„åˆ™åŒ¹é… + ä¸Šæ¸¸æŸ¥è¯¢
    let (upstream, rule_name) = self.match_domain(domain)?;
    let response = self.forward_to_upstream(request, upstream).await?;
    
    // 4ï¸âƒ£ å†™å…¥ä¸¤çº§ç¼“å­˜
    rule_cache.insert(domain, upstream_name);
    domain_cache.insert(domain, rule_name, response, ttl);
    
    Ok(response)
}
```

### 3. **åˆå§‹åŒ–å’Œç®¡ç†** ([src/main.rs](src/main.rs))

```rust
// åˆå§‹åŒ– Rule Cacheï¼ˆå†…å­˜è§„åˆ™ç¼“å­˜ï¼‰
let rule_cache = RuleCache::new();
info!("Rule Cache å·²å¯ç”¨");

// åˆ›å»ºè½¬å‘å™¨ï¼ˆä¼ å…¥ä¸¤çº§ç¼“å­˜ï¼‰
let forwarder = DnsForwarder::new(
    config,
    Some(rule_cache.clone()),
    Some(domain_cache.clone())
)?;
```

## ğŸ¯ ä¸¤çº§ç¼“å­˜ç³»ç»Ÿ

### å·¥ä½œæµç¨‹

```
DNS æŸ¥è¯¢è¯·æ±‚ (example.com)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ï¸âƒ£  Rule Cache æŸ¥è¯¢        â”‚  å†…å­˜ HashMapï¼ˆå¾®ç§’çº§ï¼‰
â”‚   domain â†’ upstream      â”‚  â†’ å‘½ä¸­ï¼šç›´æ¥ä½¿ç”¨ upstream
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â†’ æœªå‘½ä¸­ â†“
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ï¸âƒ£  Domain Cache æŸ¥è¯¢      â”‚  å†…å­˜ + TTL ç®¡ç†ï¼ˆå¾®ç§’çº§ï¼‰
â”‚   domain â†’ DNS Response  â”‚  â†’ å‘½ä¸­ï¼šè¿”å›å®Œæ•´ DNS å“åº”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â†’ æœªå‘½ä¸­ â†“
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ï¸âƒ£  Rules è§„åˆ™åŒ¹é…         â”‚  éå†é…ç½®æ–‡ä»¶ï¼ˆæ¯«ç§’çº§ï¼‰
â”‚   æ·±åº¦ä¼˜å…ˆ + é¡ºåºåŒ¹é…    â”‚  â†’ ç¡®å®šä½¿ç”¨å“ªä¸ª upstream
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ï¸âƒ£  Upstream DNS æŸ¥è¯¢     â”‚  UDP/TCP/DoH/DoTï¼ˆæ¯«ç§’çº§ï¼‰
â”‚   å‘ä¸Šæ¸¸å‘é€è¯·æ±‚         â”‚  â†’ è·å– DNS å“åº”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5ï¸âƒ£  å†™å…¥ä¸¤çº§ç¼“å­˜           â”‚
â”‚   Rule Cache âœ“          â”‚  domain â†’ upstream
â”‚   Domain Cache âœ“        â”‚  domain â†’ DNS Response
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å›ç»™å®¢æˆ·ç«¯
```

### ç¼“å­˜å¯¹æ¯”

| ç‰¹æ€§ | Rule Cache | Domain Cache |
|------|-----------|-------------|
| **å­˜å‚¨å†…å®¹** | domain â†’ upstream | domain â†’ DNS Response |
| **æ ¼å¼** | `|domain|upstream|` | `|cache_id|rule|domain|ttl|IP(...)|` |
| **å­˜å‚¨ä½ç½®** | å†…å­˜ï¼ˆHashMapï¼‰ | å†…å­˜ï¼ˆHashMap + TTLï¼‰ |
| **è¿‡æœŸæœºåˆ¶** | æ— ï¼ˆreload æ¸…ç©ºï¼‰ | åŸºäº TTL è‡ªåŠ¨è¿‡æœŸ |
| **æŸ¥è¯¢ä¼˜å…ˆçº§** | ğŸ¥‡ ç¬¬ä¸€çº§ï¼ˆæœ€é«˜ï¼‰ | ğŸ¥ˆ ç¬¬äºŒçº§ |
| **æŸ¥è¯¢é€Ÿåº¦** | âš¡ å¾®ç§’çº§ | âš¡ å¾®ç§’çº§ |
| **ç”¨é€”** | é¿å…é‡å¤è§„åˆ™åŒ¹é… | é¿å…é‡å¤ä¸Šæ¸¸æŸ¥è¯¢ |
| **æ¸…ç©ºæ—¶æœº** | reload å‘½ä»¤ | TTL è¿‡æœŸ / æ‰‹åŠ¨æ¸…ç† |

## ğŸ“Š æ€§èƒ½ä¼˜åŠ¿

### æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | æ— ç¼“å­˜ | ä»… Domain Cache | Rule + Domain Cache |
|------|--------|----------------|-------------------|
| **é¦–æ¬¡æŸ¥è¯¢** | 50-100ms | 50-100ms | 50-100ms |
| **é‡å¤æŸ¥è¯¢ï¼ˆç›¸åŒåŸŸåï¼‰** | 50-100ms | <1ms | <0.1ms |
| **ä¸åŒåŸŸåï¼ˆç›¸åŒè§„åˆ™ï¼‰** | 50-100ms | 50-100ms | ~50ms |

**Rule Cache ä¼˜åŠ¿**ï¼š
- âœ… å³ä½¿ DNS å“åº”è¿‡æœŸï¼Œä»èƒ½åŠ é€Ÿè§„åˆ™åŒ¹é…
- âœ… å‡å°‘è§„åˆ™éå†æ¬¡æ•°ï¼ˆå¯¹äºå¤§é‡è§„åˆ™å°¤å…¶é‡è¦ï¼‰
- âœ… ä¸ Domain Cache é…åˆï¼Œå®ç°æé€ŸæŸ¥è¯¢

## ğŸ”§ é…ç½®ç¤ºä¾‹

æ— éœ€é¢å¤–é…ç½®ï¼ŒRule Cache è‡ªåŠ¨å¯ç”¨ï¼š

```yaml
# cache é…ç½®ä»…ç”¨äº Domain Cache
cache:
  default:
    size: 1000        # æœ€å¤šç¼“å­˜ 1000 ä¸ªåŸŸå
    min_ttl: 60       # è‡³å°‘ç¼“å­˜ 60 ç§’
    max_ttl: 3600     # æœ€å¤šç¼“å­˜ 3600 ç§’

# Rule Cache æ— éœ€é…ç½®ï¼Œè‡ªåŠ¨å¯ç”¨
```

## ğŸ“ æ—¥å¿—è¾“å‡ºç¤ºä¾‹

å¯åŠ¨æœåŠ¡å™¨æ—¶ï¼š
```
INFO creskyDNS::cache: åˆ›å»º Rule Cache (å†…å­˜è§„åˆ™ç¼“å­˜)
INFO creskyDNS: Rule Cache å·²å¯ç”¨
INFO creskyDNS::cache: åˆ›å»º Domain Cache 'default': size=1000, min_ttl=Some(60), max_ttl=Some(3600)
INFO creskyDNS: Domain Cache å·²å¯ç”¨
```

æŸ¥è¯¢æ—¶ï¼ˆdebug æ—¥å¿—ï¼‰ï¼š
```
# é¦–æ¬¡æŸ¥è¯¢
DEBUG Rule Cache æœªå‘½ä¸­: example.com
DEBUG Domain Cache æœªå‘½ä¸­: example.com
DEBUG åŸŸå example.com åœ¨è§„åˆ™ç»„ 'main' ä¸­åŒ¹é…åˆ°ä¸Šæ¸¸ 'google'
DEBUG Rule Cache å†™å…¥: example.com -> google
DEBUG Domain Cache å†™å…¥: example.com (è§„åˆ™: main:google, TTL: 300s)

# ç¬¬äºŒæ¬¡æŸ¥è¯¢
DEBUG Rule Cache å‘½ä¸­: example.com -> google
# è·³è¿‡è§„åˆ™åŒ¹é…ï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ upstream

# ç¬¬ä¸‰æ¬¡æŸ¥è¯¢ï¼ˆDomain Cache å‘½ä¸­ï¼‰
DEBUG Rule Cache å‘½ä¸­: example.com -> google
DEBUG Domain Cache å‘½ä¸­: example.com (å‰©ä½™ TTL: 295s)
# ç›´æ¥è¿”å›ç¼“å­˜çš„ DNS å“åº”
```

## âœ… ç¼–è¯‘çŠ¶æ€

- âœ… ç¼–è¯‘æˆåŠŸï¼ˆä»…è­¦å‘Šï¼Œæ— é”™è¯¯ï¼‰
- âœ… æœåŠ¡å™¨æˆåŠŸå¯åŠ¨
- âœ… ä¸¤çº§ç¼“å­˜ç³»ç»Ÿå·²åˆå§‹åŒ–å¹¶è¿è¡Œ

```
$ cargo build
   Compiling creskyDNS v0.1.0
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 10.91s
```

## ğŸ‰ åŠŸèƒ½å®Œæˆæ€»ç»“

| åŠŸèƒ½æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| RuleCache ç»“æ„ | âœ… | HashMap å®ç°ï¼Œçº¿ç¨‹å®‰å…¨ |
| DomainCache ç»“æ„ | âœ… | å¸¦ TTL ç®¡ç†çš„ç¼“å­˜ |
| ä¸¤çº§ç¼“å­˜é›†æˆ | âœ… | process_request ä¸­å®Œæ•´å®ç° |
| ç¼“å­˜å†™å…¥é€»è¾‘ | âœ… | æŸ¥è¯¢åè‡ªåŠ¨å†™å…¥ä¸¤çº§ç¼“å­˜ |
| ç¼“å­˜æŸ¥è¯¢é€»è¾‘ | âœ… | Rule Cache â†’ Domain Cache â†’ è§„åˆ™åŒ¹é… |
| æ¸…ç©ºæœºåˆ¶ | âœ… | Rule Cache æ”¯æŒ clear()ï¼ŒDomain Cache æ”¯æŒ TTL è¿‡æœŸ |
| æ—¥å¿—è¾“å‡º | âœ… | debug/info çº§åˆ«å®Œæ•´æ—¥å¿— |
| é…ç½®åŠ è½½ | âœ… | ä» config.yaml åŠ è½½ Domain Cache é…ç½® |

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **æŒä¹…åŒ– Rule Cache**ï¼šå¯é€‰åŠŸèƒ½ï¼Œå®šæœŸä¿å­˜åˆ°æ–‡ä»¶ï¼ˆç±»ä¼¼ domain.cacheï¼‰
2. **ç¼“å­˜ç»Ÿè®¡æ¥å£**ï¼šæ·»åŠ  HTTP API æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡
3. **ç¼“å­˜å¤§å°é™åˆ¶**ï¼šä¸º Rule Cache æ·»åŠ  LRU æ·˜æ±°æœºåˆ¶
4. **æ€§èƒ½ç›‘æ§**ï¼šè®°å½•æ¯æ¬¡æŸ¥è¯¢çš„ç¼“å­˜å‘½ä¸­æƒ…å†µå’Œè€—æ—¶

---

**å®ç°å®Œæˆæ—¶é—´**: 2026-01-11  
**åŠŸèƒ½çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶å¯æ­£å¸¸ä½¿ç”¨
