# 02 - ç›‘å¬å™¨æ¨¡å—

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [å¤šç›‘å¬å™¨æ¶æ„](#å¤šç›‘å¬å™¨æ¶æ„)
- [åè®®æ”¯æŒ](#åè®®æ”¯æŒ)
- [ç«¯å£é…ç½®](#ç«¯å£é…ç½®)
- [é…ç½®ç¤ºä¾‹](#é…ç½®ç¤ºä¾‹)
- [ä½¿ç”¨åœºæ™¯](#ä½¿ç”¨åœºæ™¯)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¦‚è¿°

creskyDNS æ”¯æŒå¼ºå¤§çš„å¤šç›‘å¬å™¨æ¶æ„ï¼Œå…è®¸åŒæ—¶å¯åŠ¨å¤šä¸ª DNS æœåŠ¡å®ä¾‹ï¼Œæ¯ä¸ªç›‘å¬å™¨å¯ä»¥ç‹¬ç«‹é…ç½®ç«¯å£ã€åè®®å’Œè§„åˆ™ã€‚

### æ ¸å¿ƒç‰¹æ€§

âœ… **å¤šç›‘å¬å™¨æ”¯æŒ**ï¼šåŒæ—¶å¯åŠ¨å¤šä¸ª DNS æœåŠ¡å®ä¾‹  
âœ… **çµæ´»ç«¯å£é…ç½®**ï¼šæ¯ä¸ªç›‘å¬å™¨ç»‘å®šä¸åŒç«¯å£  
âœ… **åŒåè®®æ”¯æŒ**ï¼šè‡ªåŠ¨åŒæ—¶ç›‘å¬ UDP å’Œ TCP  
âœ… **IPv4/IPv6**ï¼šæ”¯æŒåŒæ ˆç½‘ç»œ  
âœ… **ç‹¬ç«‹è§„åˆ™**ï¼šæ¯ä¸ªç›‘å¬å™¨å¯é…ç½®ä¸åŒçš„è½¬å‘è§„åˆ™  
âœ… **é«˜å¹¶å‘**ï¼šåŸºäº Tokio å¼‚æ­¥è¿è¡Œæ—¶ï¼Œæ”¯æŒé«˜å¹¶å‘è¯·æ±‚

---

## é…ç½®è¯´æ˜

### åŸºæœ¬é…ç½®æ ¼å¼

```yaml
listener:
  ç›‘å¬å™¨åç§°: ç«¯å£å·
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| **ç›‘å¬å™¨åç§°** | string | ç›‘å¬å™¨çš„å”¯ä¸€æ ‡è¯†ç¬¦ |
| **ç«¯å£å·** | integer | ç›‘å¬çš„ç«¯å£å·ï¼ˆ1-65535ï¼‰ |

### ç®€å•é…ç½®ç¤ºä¾‹

```yaml
listener:
  main: 5353        # ä¸»ç›‘å¬å™¨ï¼Œç›‘å¬ 5353 ç«¯å£
```

è¿™ä¸ªç®€å•é…ç½®ä¼šï¼š
- åˆ›å»ºåä¸º `main` çš„ç›‘å¬å™¨
- ç›‘å¬ `0.0.0.0:5353`ï¼ˆæ‰€æœ‰ç½‘å¡ï¼‰
- åŒæ—¶å¯åŠ¨ UDP å’Œ TCP ç›‘å¬

---

## å¤šç›‘å¬å™¨æ¶æ„

### å¤šç›‘å¬å™¨é…ç½®

```yaml
listener:
  main: 5353        # ä¸»æœåŠ¡
  backup: 5354      # å¤‡ç”¨æœåŠ¡
  test: 5355        # æµ‹è¯•æœåŠ¡
  internal: 53      # å†…ç½‘æœåŠ¡ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
```

### ç›‘å¬å™¨ç‰¹æ€§

æ¯ä¸ªç›‘å¬å™¨ï¼š
- **ç‹¬ç«‹ç»‘å®š**ï¼šç›‘å¬ä¸åŒçš„ç«¯å£
- **ç‹¬ç«‹è§„åˆ™**ï¼šå¯ä»¥é…ç½®ä¸åŒçš„è½¬å‘è§„åˆ™
- **åŒæ—¶åè®®**ï¼šè‡ªåŠ¨åŒæ—¶ç›‘å¬ UDP å’Œ TCP
- **å¹¶å‘å¤„ç†**ï¼šæ¯ä¸ªç›‘å¬å™¨ç‹¬ç«‹å¤„ç†è¯·æ±‚

### ç›‘å¬å™¨è§„åˆ™é…ç½®

```yaml
# ç›‘å¬å™¨é…ç½®
listener:
  main: 5353
  backup: 5354
  test: 5355

# ä¸Šæ¸¸ DNS é…ç½®
upstreams:
  ali:
    addr: "https://dns.alidns.com/dns-query"
  google:
    addr: "https://dns.google/dns-query"
  cloudflare:
    addr: "https://cloudflare-dns.com/dns-query"

# è§„åˆ™é…ç½®
rules:
  # åŸŸåè§„åˆ™ç»„ï¼ˆæ‰€æœ‰ç›‘å¬å™¨å…±äº«ï¼‰
  main:
    - direct,ali
    - proxy,google

  # ç›‘å¬å™¨è§„åˆ™ç»„ï¼ˆé’ˆå¯¹ç‰¹å®šç›‘å¬å™¨ï¼‰
  servers:
    - main,ali                # main ç›‘å¬å™¨ä½¿ç”¨ ali
    - backup,google           # backup ç›‘å¬å™¨ä½¿ç”¨ google
    - test,cloudflare         # test ç›‘å¬å™¨ä½¿ç”¨ cloudflare
```

**è¯´æ˜**ï¼š
- `main` è§„åˆ™ç»„ï¼šåŸºäºåŸŸååŒ¹é…ï¼Œæ‰€æœ‰ç›‘å¬å™¨å…±äº«
- `servers` è§„åˆ™ç»„ï¼šåŸºäºç›‘å¬å™¨åç§°ï¼Œä¸ºä¸åŒç›‘å¬å™¨æŒ‡å®šä¸åŒçš„ä¸Šæ¸¸

---

## åè®®æ”¯æŒ

### UDP åè®®

**ç‰¹ç‚¹**ï¼š
- æ ‡å‡† DNS åè®®
- ä½å»¶è¿Ÿ
- æ— è¿æ¥çŠ¶æ€
- é€‚åˆå°æ•°æ®åŒ…

**ä½¿ç”¨åœºæ™¯**ï¼š
- å¤§éƒ¨åˆ† DNS æŸ¥è¯¢
- æœ¬åœ°ç½‘ç»œæŸ¥è¯¢
- ä½å»¶è¿Ÿè¦æ±‚

### TCP åè®®

**ç‰¹ç‚¹**ï¼š
- å¯é ä¼ è¾“
- æ”¯æŒå¤§å“åº”ï¼ˆ> 512 å­—èŠ‚ï¼‰
- è¿æ¥çŠ¶æ€
- é€‚åˆå¤§æ•°æ®åŒ…

**ä½¿ç”¨åœºæ™¯**ï¼š
- DNSSEC æŸ¥è¯¢
- å¤§å“åº”æ•°æ®
- éœ€è¦å¯é ä¼ è¾“

### è‡ªåŠ¨åè®®é€‰æ‹©

creskyDNS è‡ªåŠ¨åŒæ—¶å¯åŠ¨ UDP å’Œ TCP ç›‘å¬å™¨ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©åè®®ï¼š

```
å¯åŠ¨ç›‘å¬å™¨ 'main' åœ¨ç«¯å£ 5353
    â†“
è‡ªåŠ¨å¯åŠ¨ä¸¤ä¸ªæœåŠ¡
    â”œâ”€ UDP ç›‘å¬å™¨: 0.0.0.0:5353
    â””â”€ TCP ç›‘å¬å™¨: 0.0.0.0:5353
```

---

## ç«¯å£é…ç½®

### æ ‡å‡†ç«¯å£

| ç«¯å£ | ç”¨é€” | æƒé™è¦æ±‚ |
|------|------|----------|
| **53** | DNS æ ‡å‡†ç«¯å£ | éœ€è¦ç®¡ç†å‘˜æƒé™ |
| **5353** | mDNS / éç‰¹æƒç«¯å£ | æ™®é€šç”¨æˆ·å¯ç”¨ |
| **8053** | å¸¸ç”¨å¤‡ç”¨ç«¯å£ | æ™®é€šç”¨æˆ·å¯ç”¨ |

### ç«¯å£é€‰æ‹©å»ºè®®

#### å¼€å‘ç¯å¢ƒ

```yaml
listener:
  main: 5353        # ä¸éœ€è¦ç®¡ç†å‘˜æƒé™
```

#### ç”Ÿäº§ç¯å¢ƒï¼ˆLinuxï¼‰

```yaml
listener:
  main: 53          # æ ‡å‡† DNS ç«¯å£
```

**æ³¨æ„**ï¼šåœ¨ Linux ä¸Šç›‘å¬ 53 ç«¯å£éœ€è¦ï¼š
1. ä½¿ç”¨ root æƒé™è¿è¡Œ
2. æˆ–ä½¿ç”¨ `setcap` èµ‹äºˆèƒ½åŠ›ï¼š
   ```bash
   sudo setcap 'cap_net_bind_service=+ep' /path/to/creskyDNS
   ```

#### Windows ç¯å¢ƒ

```yaml
listener:
  main: 53          # Windows ä¸ä¸¥æ ¼é™åˆ¶ç«¯å£
```

### ç«¯å£å†²çªå¤„ç†

å¦‚æœç«¯å£è¢«å ç”¨ï¼ŒcreskyDNS ä¼šï¼š
1. è¾“å‡ºé”™è¯¯æ—¥å¿—
2. åœæ­¢å¯åŠ¨
3. è¿”å›é”™è¯¯ç 

**æ£€æŸ¥ç«¯å£å ç”¨**ï¼š

```bash
# Linux/macOS
sudo lsof -i :5353
sudo netstat -tunlp | grep 5353

# Windows
netstat -ano | findstr :5353
```

---

## é…ç½®ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå•ç›‘å¬å™¨ï¼ˆæœ€ç®€å•ï¼‰

```yaml
listener:
  main: 5353

upstreams:
  google:
    addr: "https://dns.google/dns-query"

rules:
  main:
    - .,google
```

### ç¤ºä¾‹ 2ï¼šä¸»å¤‡ç›‘å¬å™¨

```yaml
listener:
  main: 5353        # ä¸»æœåŠ¡
  backup: 5354      # å¤‡ç”¨æœåŠ¡

upstreams:
  ali:
    addr: "https://dns.alidns.com/dns-query"
  google:
    addr: "https://dns.google/dns-query"

rules:
  main:
    - direct,ali
    - proxy,google
  
  servers:
    - main,ali      # ä¸»æœåŠ¡ä¼˜å…ˆä½¿ç”¨é˜¿é‡Œ DNS
    - backup,google # å¤‡ç”¨æœåŠ¡ä½¿ç”¨ Google DNS
```

### ç¤ºä¾‹ 3ï¼šå¤šç¯å¢ƒç›‘å¬å™¨

```yaml
listener:
  production: 53    # ç”Ÿäº§ç¯å¢ƒï¼ˆæ ‡å‡†ç«¯å£ï¼‰
  staging: 5353     # æµ‹è¯•ç¯å¢ƒ
  development: 5354 # å¼€å‘ç¯å¢ƒ

upstreams:
  prod_dns:
    addr: "https://dns.prod.company.com/dns-query"
  test_dns:
    addr: "https://dns.test.company.com/dns-query"
  dev_dns:
    addr: "udp://192.168.1.1:53"

rules:
  servers:
    - production,prod_dns
    - staging,test_dns
    - development,dev_dns
```

### ç¤ºä¾‹ 4ï¼šä¼ä¸šå†…ç½‘ï¼ˆå¤šç›‘å¬å™¨ + å¤šè§„åˆ™ï¼‰

```yaml
listener:
  internal: 53      # å†…ç½‘æ ‡å‡†ç«¯å£
  external: 5353    # å¤–ç½‘è®¿é—®ç«¯å£
  dmz: 5354         # DMZ åŒºåŸŸç«¯å£

upstreams:
  internal_dns:
    addr: "udp://192.168.1.1:53"
  external_dns:
    addr: "https://dns.google/dns-query"
  dmz_dns:
    addr: "https://dns.cloudflare.com/dns-query"

lists:
  internal_domains:
    type: "domain"
    domains:
      - company.com
      - internal.local
  
  dmz_domains:
    type: "domain"
    domains:
      - api.company.com
      - www.company.com

rules:
  main:
    - internal_domains,internal_dns
    - dmz_domains,dmz_dns
    - .,external_dns
  
  servers:
    - internal,internal_dns
    - external,external_dns
    - dmz,dmz_dns
```

---

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šå¼€å‘æµ‹è¯•éš”ç¦»

**éœ€æ±‚**ï¼šå¼€å‘å’Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸åŒçš„ DNS

```yaml
listener:
  dev: 5353         # å¼€å‘ç¯å¢ƒ
  prod: 5354        # ç”Ÿäº§ç¯å¢ƒ

upstreams:
  dev_dns:
    addr: "udp://192.168.1.1:53"
  prod_dns:
    addr: "https://dns.google/dns-query"

rules:
  servers:
    - dev,dev_dns
    - prod,prod_dns
```

**ä½¿ç”¨**ï¼š
```bash
# å¼€å‘ç¯å¢ƒæŸ¥è¯¢
nslookup example.com 127.0.0.1 -port=5353

# ç”Ÿäº§ç¯å¢ƒæŸ¥è¯¢
nslookup example.com 127.0.0.1 -port=5354
```

### åœºæ™¯ 2ï¼šç½‘ç»œåˆ†åŒº

**éœ€æ±‚**ï¼šå†…ç½‘å’Œå¤–ç½‘ä½¿ç”¨ä¸åŒçš„ DNS æœåŠ¡å™¨

```yaml
listener:
  internal: 53      # å†…ç½‘ç›‘å¬
  external: 5353    # å¤–ç½‘ç›‘å¬

upstreams:
  lan_dns:
    addr: "udp://192.168.1.1:53"
  wan_dns:
    addr: "https://dns.google/dns-query"

rules:
  servers:
    - internal,lan_dns
    - external,wan_dns
```

### åœºæ™¯ 3ï¼šè´Ÿè½½å‡è¡¡

**éœ€æ±‚**ï¼šå¤šä¸ªç›‘å¬å™¨åˆ†æ‹…è´Ÿè½½

```yaml
listener:
  dns1: 5353
  dns2: 5354
  dns3: 5355

upstreams:
  upstream1:
    addr: "https://dns.google/dns-query"
  upstream2:
    addr: "https://cloudflare-dns.com/dns-query"
  upstream3:
    addr: "https://dns.alidns.com/dns-query"

rules:
  servers:
    - dns1,upstream1
    - dns2,upstream2
    - dns3,upstream3
```

**å®¢æˆ·ç«¯é…ç½®**ï¼š
```
DNS Server 1: 127.0.0.1:5353
DNS Server 2: 127.0.0.1:5354
DNS Server 3: 127.0.0.1:5355
```

### åœºæ™¯ 4ï¼šå®‰å…¨éš”ç¦»

**éœ€æ±‚**ï¼šä¸åŒå®‰å…¨åŒºåŸŸä½¿ç”¨ä¸åŒçš„ DNS

```yaml
listener:
  trust: 53         # å¯ä¿¡åŒºåŸŸ
  dmz: 5353         # DMZ åŒºåŸŸ
  untrust: 5354     # ä¸å¯ä¿¡åŒºåŸŸ

upstreams:
  trust_dns:
    addr: "udp://10.0.0.1:53"
  dmz_dns:
    addr: "https://dns.cloudflare.com/dns-query"
  untrust_dns:
    addr: "https://dns.google/dns-query"

rules:
  servers:
    - trust,trust_dns
    - dmz,dmz_dns
    - untrust,untrust_dns
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šç›‘å¬å™¨å¯åŠ¨å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ERROR: ç›‘å¬å™¨ 'main' å¯åŠ¨å¤±è´¥: Address already in use
```

**åŸå› **ï¼šç«¯å£è¢«å ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ç«¯å£å ç”¨ï¼š
   ```bash
   # Linux
   sudo lsof -i :5353
   
   # Windows
   netstat -ano | findstr :5353
   ```

2. åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹æˆ–æ›´æ¢ç«¯å£ï¼š
   ```yaml
   listener:
     main: 5354  # ä½¿ç”¨å…¶ä»–ç«¯å£
   ```

### é—®é¢˜ 2ï¼šæƒé™ä¸è¶³

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ERROR: ç›‘å¬å™¨ 'main' å¯åŠ¨å¤±è´¥: Permission denied
```

**åŸå› **ï¼šç›‘å¬ < 1024 ç«¯å£éœ€è¦ç®¡ç†å‘˜æƒé™

**è§£å†³æ–¹æ¡ˆ**ï¼š

**Linux**ï¼š
```bash
# æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ root æƒé™
sudo ./creskyDNS

# æ–¹æ¡ˆ 2ï¼šèµ‹äºˆèƒ½åŠ›
sudo setcap 'cap_net_bind_service=+ep' ./creskyDNS
./creskyDNS
```

**Windows**ï¼š
```powershell
# ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ PowerShell
.\creskyDNS.exe
```

### é—®é¢˜ 3ï¼šç›‘å¬å™¨æ— å“åº”

**æ£€æŸ¥æ­¥éª¤**ï¼š

1. æ£€æŸ¥ç›‘å¬å™¨æ˜¯å¦å¯åŠ¨ï¼š
   ```bash
   netstat -tunlp | grep 5353
   ```

2. æµ‹è¯•è¿æ¥ï¼š
   ```bash
   # UDP æµ‹è¯•
   nslookup google.com 127.0.0.1 -port=5353
   
   # TCP æµ‹è¯•
   dig @127.0.0.1 -p 5353 google.com +tcp
   ```

3. æ£€æŸ¥é˜²ç«å¢™ï¼š
   ```bash
   # Linux
   sudo iptables -L -n | grep 5353
   
   # Windows
   netsh advfirewall firewall show rule name=all | findstr 5353
   ```

### é—®é¢˜ 4ï¼šç›‘å¬å™¨è§„åˆ™ä¸ç”Ÿæ•ˆ

**æ£€æŸ¥é…ç½®**ï¼š

```yaml
rules:
  # âœ“ æ­£ç¡®ï¼šservers è§„åˆ™ç»„
  servers:
    - main,upstream1
  
  # âœ— é”™è¯¯ï¼šç›‘å¬å™¨åç§°æ‹¼å†™é”™è¯¯
  servers:
    - mian,upstream1  # æ‹¼å†™é”™è¯¯
```

**éªŒè¯æ–¹æ³•**ï¼š
1. æ£€æŸ¥æ—¥å¿—ï¼Œç¡®è®¤ç›‘å¬å™¨å¯åŠ¨
2. æµ‹è¯•æŸ¥è¯¢ï¼Œè§‚å¯Ÿä½¿ç”¨çš„ä¸Šæ¸¸
3. æ£€æŸ¥è§„åˆ™é…ç½®æ˜¯å¦æ­£ç¡®

---

## æœ€ä½³å®è·µ

### 1. ç«¯å£é€‰æ‹©

âœ… **æ¨è**ï¼š
- å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨éç‰¹æƒç«¯å£ï¼ˆ5353ã€8053ï¼‰
- ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨æ ‡å‡†ç«¯å£ï¼ˆ53ï¼‰
- é¿å…ä¸å…¶ä»–æœåŠ¡å†²çª

âŒ **ä¸æ¨è**ï¼š
- ä½¿ç”¨éšæœºç«¯å£ï¼ˆä¸ä¾¿äºå®¢æˆ·ç«¯é…ç½®ï¼‰
- ä½¿ç”¨çŸ¥åæœåŠ¡ç«¯å£ï¼ˆå¦‚ 80ã€443ï¼‰

### 2. ç›‘å¬å™¨å‘½å

âœ… **æ¨è**ï¼š
- ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°ï¼ˆmainã€backupã€internalï¼‰
- ä½¿ç”¨å°å†™å­—æ¯
- é¿å…ç‰¹æ®Šå­—ç¬¦

âŒ **ä¸æ¨è**ï¼š
- ä½¿ç”¨æ•°å­—å‘½åï¼ˆ1ã€2ã€3ï¼‰
- ä½¿ç”¨ä¸­æ–‡å‘½å
- åç§°è¿‡é•¿

### 3. è§„åˆ™é…ç½®

âœ… **æ¨è**ï¼š
- ä¸ºæ¯ä¸ªç›‘å¬å™¨é…ç½®ç‹¬ç«‹è§„åˆ™
- ä½¿ç”¨ `servers` è§„åˆ™ç»„ç®¡ç†ç›‘å¬å™¨
- ä¿æŒè§„åˆ™ç®€æ´æ¸…æ™°

âŒ **ä¸æ¨è**ï¼š
- æ‰€æœ‰ç›‘å¬å™¨ä½¿ç”¨ç›¸åŒè§„åˆ™ï¼ˆå¤±å»å¤šç›‘å¬å™¨çš„æ„ä¹‰ï¼‰
- è¿‡åº¦å¤æ‚çš„è§„åˆ™é…ç½®

### 4. å®‰å…¨é…ç½®

âœ… **æ¨è**ï¼š
- é™åˆ¶ç›‘å¬åœ°å€ï¼ˆä¸è¦æš´éœ²åˆ°å…¬ç½‘ï¼‰
- ä½¿ç”¨é˜²ç«å¢™é™åˆ¶è®¿é—®
- å®šæœŸå®¡æŸ¥ç›‘å¬å™¨é…ç½®

âŒ **ä¸æ¨è**ï¼š
- å°†ç›‘å¬å™¨ç›´æ¥æš´éœ²åˆ°å…¬ç½‘
- ä½¿ç”¨é»˜è®¤é…ç½®ä¸åŠ é™åˆ¶

### 5. æ€§èƒ½ä¼˜åŒ–

âœ… **æ¨è**ï¼š
- æ ¹æ®è´Ÿè½½é…ç½®å¤šä¸ªç›‘å¬å™¨
- ä½¿ç”¨è´Ÿè½½å‡è¡¡åˆ†å‘è¯·æ±‚
- ç›‘æ§æ¯ä¸ªç›‘å¬å™¨çš„æ€§èƒ½

---

## ç›¸å…³æ–‡æ¡£

- [01-LOG.md](01-LOG.md) - æ—¥å¿—æ¨¡å—
- [03-CACHE.md](03-CACHE.md) - ç¼“å­˜æ¨¡å—
- [04-UPSTREAMS.md](04-UPSTREAMS.md) - ä¸Šæ¸¸æœåŠ¡å™¨æ¨¡å—
- [05-LISTS.md](05-LISTS.md) - åˆ—è¡¨æ¨¡å—
- [06-RULES.md](06-RULES.md) - è§„åˆ™æ¨¡å—
