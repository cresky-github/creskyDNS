# 06 - è§„åˆ™æ¨¡å—

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [è§„åˆ™ç»„å·¥ä½œåŸç†](#è§„åˆ™ç»„å·¥ä½œåŸç†)
- [åŒ¹é…ä¼˜å…ˆçº§](#åŒ¹é…ä¼˜å…ˆçº§)
- [åŸŸåæ·±åº¦åŒ¹é…](#åŸŸåæ·±åº¦åŒ¹é…)
- [Final è§„åˆ™](#final-è§„åˆ™)
- [è§„åˆ™å‘½ä¸­è¿½è¸ª](#è§„åˆ™å‘½ä¸­è¿½è¸ª)
- [é…ç½®ç¤ºä¾‹](#é…ç½®ç¤ºä¾‹)
- [å®ä¾‹æ¼”ç¤º](#å®ä¾‹æ¼”ç¤º)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¦‚è¿°

è§„åˆ™æ¨¡å—æ˜¯ creskyDNS çš„æ ¸å¿ƒï¼Œè´Ÿè´£æ ¹æ®åŸŸååˆ—è¡¨å’Œç›‘å¬å™¨å°† DNS æŸ¥è¯¢åˆ†æµåˆ°ä¸åŒçš„ä¸Šæ¸¸æœåŠ¡å™¨ã€‚

### æ ¸å¿ƒç‰¹æ€§

âœ… **å¤šè§„åˆ™ç»„**ï¼šæ”¯æŒå¤šä¸ªè§„åˆ™ç»„ï¼ŒæŒ‰é¡ºåºåŒ¹é…  
âœ… **çŸ­è·¯é€»è¾‘**ï¼šç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™ç»„ç«‹å³è¿”å›  
âœ… **æ·±åº¦ä¼˜å…ˆ**ï¼šåŸŸåæ·±åº¦è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜  
âœ… **Final è§„åˆ™**ï¼šå…œåº•è§„åˆ™ï¼Œå¤„ç†æœªåŒ¹é…çš„æŸ¥è¯¢  
âœ… **ç›‘å¬å™¨è§„åˆ™**ï¼šä¸åŒç›‘å¬å™¨ä½¿ç”¨ä¸åŒä¸Šæ¸¸  
âœ… **è§„åˆ™è¿½è¸ª**ï¼šè‡ªåŠ¨ç”Ÿæˆ `.hit.txt` æ–‡ä»¶

---

## è§„åˆ™ç»„å·¥ä½œåŸç†

### åŸºæœ¬ç»“æ„

```yaml
rules:
  è§„åˆ™ç»„åç§°:        # æŒ‰å®šä¹‰é¡ºåºå¤„ç†
    - åˆ—è¡¨å,ä¸Šæ¸¸å
    - åˆ—è¡¨å,ä¸Šæ¸¸å
```

### åŒ¹é…æµç¨‹

#### ç¬¬ä¸€æ­¥ï¼šæŒ‰ YAML é¡ºåºé€ä¸€æ£€æŸ¥è§„åˆ™ç»„

æŒ‰é…ç½®æ–‡ä»¶ä¸­**å®šä¹‰çš„é¡ºåº**ï¼Œé€ä¸ªæ£€æŸ¥æ¯ä¸ªè§„åˆ™ç»„ã€‚

> **å…³é”®ç‚¹ï¼šä¸€æ—¦æŸä¸ªè§„åˆ™ç»„æœ‰åŒ¹é…ï¼Œç«‹å³è¿”å›ç»“æœï¼Œä¸å†æ£€æŸ¥åç»­è§„åˆ™ç»„ï¼**

```
è§„åˆ™ç»„éå†è¿‡ç¨‹ï¼š
group1 â†’ æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…
    â†“
  æœ‰åŒ¹é…? 
    â†“ æ˜¯
  ã€è¿”å›ç»“æœã€‘â† ä¸å†æ£€æŸ¥ group2, group3, ...
    â†“ å¦
  ç»§ç»­åˆ° group2
group2 â†’ æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…
    â†“
  æœ‰åŒ¹é…?
    â†“ æ˜¯
  ã€è¿”å›ç»“æœã€‘â† ä¸å†æ£€æŸ¥ group3, ...
    â†“ å¦
  ç»§ç»­åˆ° group3
...
```

#### ç¬¬äºŒæ­¥ï¼šåœ¨è§„åˆ™ç»„å†…åŒæ—¶åŒ¹é…æ‰€æœ‰è§„åˆ™

å¯¹äºå½“å‰è§„åˆ™ç»„ï¼ŒåŒæ—¶å¯¹æ‰€æœ‰è§„åˆ™è¿›è¡Œè¯„ä¼°ï¼ŒæŸ¥æ‰¾åŒ¹é…çš„è§„åˆ™ã€‚

**åŒ¹é…æ–¹å¼**ï¼šDomain Suffixï¼ˆåŸŸååç¼€åŒ¹é…ï¼‰
- æ”¯æŒå¤šçº§åŸŸååŒ¹é…
- ä¾‹å¦‚ï¼šé…ç½®äº† `example.com`ï¼Œå¯åŒ¹é…ï¼š
  - `example.com` âœ“
  - `www.example.com` âœ“
  - `api.service.example.com` âœ“
  - `other.example.org` âœ—

#### ç¬¬ä¸‰æ­¥ï¼šè§„åˆ™ç»„å†…çš„ä¼˜å…ˆçº§æ’åº

å¯¹äºæ‰€æœ‰åŒ¹é…çš„è§„åˆ™ï¼ŒæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§æ’åºï¼š

**1. åŸŸåæ·±åº¦ï¼ˆDomain Depthï¼‰** - æœ€é‡è¦
- æ·±åº¦ = åŒ¹é…çš„åŸŸåå±‚çº§æ•°
- æ·±åº¦å¤§çš„ä¼˜å…ˆï¼ˆæ›´å…·ä½“çš„åŒ¹é…ï¼‰

**2. è§„åˆ™é¡ºåºï¼ˆRule Indexï¼‰** - æ¬¡è¦
- å½“å¤šä¸ªè§„åˆ™æ·±åº¦ç›¸åŒæ—¶
- **é€‰æ‹©åœ¨åˆ—è¡¨ä¸­æœ€åå‡ºç°çš„è§„åˆ™**

#### ç¬¬å››æ­¥ï¼šè¿”å›ç»“æœ

è¿”å›åŒ¹é…è§„åˆ™å¯¹åº”çš„ä¸Šæ¸¸ DNS æœåŠ¡å™¨é…ç½®ã€‚

---

## åŒ¹é…ä¼˜å…ˆçº§

### ä¼˜å…ˆçº§è¯´æ˜

è§„åˆ™åŒ¹é…çš„ä¼˜å…ˆçº§ï¼ˆç”±é«˜åˆ°ä½ï¼‰ï¼š

| ä¼˜å…ˆçº§ | è§„åˆ™ | è¯´æ˜ |
|--------|------|------|
| **1** | **YAML è§„åˆ™ç»„é¡ºåº** | æŒ‰é…ç½®æ–‡ä»¶å®šä¹‰é¡ºåºé€ä¸€æ£€æŸ¥ï¼Œ**ç¬¬ä¸€ä¸ªæœ‰åŒ¹é…çš„è§„åˆ™ç»„è¢«ä½¿ç”¨** |
| 2 | åŸŸåæ·±åº¦ | è§„åˆ™ç»„å†…ï¼Œæ·±åº¦å¤§çš„è§„åˆ™ä¼˜å…ˆ |
| 3 | è§„åˆ™é¡ºåº | æ·±åº¦ç›¸åŒæ—¶ï¼Œé€‰æ‹©åˆ—è¡¨ä¸­æœ€åçš„è§„åˆ™ |

### å…³é”®ç‰¹æ€§

- **çŸ­è·¯é€»è¾‘**ï¼šä¸€æ—¦æŸä¸ª group æœ‰åŒ¹é…ï¼Œç«‹å³è¿”å›
- âŒ è§„åˆ™ç»„åç§°**ä¸å½±å“**å¤„ç†é¡ºåº
- âœ“ è§„åˆ™ç»„**åœ¨é…ç½®æ–‡ä»¶ä¸­çš„ä½ç½®**å†³å®šäº†å¤„ç†é¡ºåº
- âœ“ è®¾è®¡ä¼˜åŠ¿ï¼šå¯ä»¥è®¾ç½®é«˜ä¼˜å…ˆçº§è§„åˆ™ç»„åœ¨å‰ï¼Œä½ä¼˜å…ˆçº§åœ¨å

### ç¤ºä¾‹

```yaml
rules:
  # è§„åˆ™ç»„ 1ï¼šå®‰å…¨é˜²æŠ¤ï¼ˆæœ€å…ˆæ£€æŸ¥ï¼‰
  security:
    - ads,blocker
    - malware,blocker
  
  # è§„åˆ™ç»„ 2ï¼šå›½å†…åˆ†æµï¼ˆæ¬¡æ£€æŸ¥ï¼‰
  domestic:
    - direct,local_dns
  
  # è§„åˆ™ç»„ 3ï¼šå›½é™…åˆ†æµï¼ˆæœ€åæ£€æŸ¥ï¼‰
  international:
    - proxy,overseas_dns
```

**å¤„ç†é¡ºåº**ï¼š`security` â†’ `domestic` â†’ `international`

**æŸ¥è¯¢ `ads.example.com`**ï¼š
```
1. æ£€æŸ¥ security group
   â”œâ”€ ads list ä¸­æœ‰åŒ¹é…? âœ“ æ˜¯ï¼
   â”œâ”€ è¿”å› blocker upstream
   â””â”€ ã€åœæ­¢ã€‘â† ä¸å†æ£€æŸ¥ domestic å’Œ international
```

---

## åŸŸåæ·±åº¦åŒ¹é…

### æ·±åº¦å®šä¹‰

åŸŸåæ·±åº¦ï¼ˆDomain Depthï¼‰æ˜¯æŒ‡åŸŸåå±‚çº§çš„æ•°é‡ï¼š

| åŸŸå | æ·±åº¦ | è¯´æ˜ |
|------|------|------|
| `.` | 0 | æ ¹åŸŸå |
| `com` | 1 | é¡¶çº§åŸŸå (TLD) |
| `google.com` | 2 | äºŒçº§åŸŸå |
| `www.google.com` | 3 | ä¸‰çº§åŸŸå |
| `api.www.google.com` | 4 | å››çº§åŸŸå |

### è®¡ç®—æ–¹æ³•

```
æ·±åº¦ = ç‚¹å·æ•°é‡ + 1

ç‰¹æ®Šæƒ…å†µï¼š
- `.` (æ ¹åŸŸå) â†’ æ·±åº¦ = 0
- ç©ºå­—ç¬¦ä¸² â†’ æ— æ•ˆåŸŸå
```

### åŒ¹é…ä¼˜å…ˆçº§

æŸ¥è¯¢ `api.service.example.com` æ—¶çš„åŒ¹é…ä¼˜å…ˆçº§ï¼š

| åˆ—è¡¨ä¸­çš„åŸŸå | æ·±åº¦ | ä¼˜å…ˆçº§ |
|-------------|------|--------|
| `.` | 0 | æœ€ä½ |
| `com` | 1 | ä½ |
| `example.com` | 2 | ä¸­ |
| `service.example.com` | 3 | é«˜ |
| `api.service.example.com` | 4 | **æœ€é«˜**ï¼ˆæœ€ç²¾ç¡®ï¼‰ |

**é€‰æ‹©åŸåˆ™**ï¼šä¼˜å…ˆé€‰æ‹©æ·±åº¦æœ€å¤§çš„è§„åˆ™ï¼ˆæœ€ç²¾ç¡®åŒ¹é…ï¼‰

### æ·±åº¦ç›¸åŒæ—¶çš„æ’åº

å½“å¤šä¸ªè§„åˆ™æ·±åº¦ç›¸åŒæ—¶ï¼Œ**é€‰æ‹©åœ¨åˆ—è¡¨ä¸­æœ€åå‡ºç°çš„è§„åˆ™**ï¼š

```yaml
rules:
  group:
    - list1,upstream1  # index=0, depth=2
    - list2,upstream2  # index=1, depth=2 â† é€‰ä¸­ï¼ï¼ˆæœ€åä¸€ä¸ªï¼‰
```

---

## Final è§„åˆ™

### åŠŸèƒ½è¯´æ˜

**Final è§„åˆ™**æ˜¯å…œåº•è§„åˆ™ï¼Œç”¨äºå¤„ç†æœªåŒ¹é…åˆ°ä»»ä½•è§„åˆ™çš„æŸ¥è¯¢ã€‚

### é…ç½®æ ¼å¼

```yaml
rules:
  main:
    - direct,ali_dns
    - proxy,google_dns
  
  final:
    primary_upstream: "ali_dns"
    fallback_upstream: "google_dns"
    ipcidr: "china_ips"           # å¯é€‰ï¼šIP CIDR åˆ—è¡¨
    output: "./output/domains.txt" # å¯é€‰ï¼šè¾“å‡ºæ–‡ä»¶
```

### é…ç½®å­—æ®µ

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| **primary_upstream** | string | âœ… | ä¸»ä¸Šæ¸¸ DNS æ ‡ç­¾ |
| **fallback_upstream** | string | âœ… | å¤‡ç”¨ä¸Šæ¸¸ DNS æ ‡ç­¾ |
| **ipcidr** | string | å¦ | IP CIDR åˆ—è¡¨åç§°ï¼ˆç”¨äºå›½å®¶ä»£ç åˆ¤å®šï¼‰ |
| **output** | string | å¦ | è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼ˆè®°å½•æœªåˆ†ç±»åŸŸåï¼‰ |

### å·¥ä½œæµç¨‹

```
æ”¶åˆ°æœªåŒ¹é…çš„ DNS æŸ¥è¯¢
    â†“
ä½¿ç”¨ primary_upstream æŸ¥è¯¢
    â†“
è·å–å“åº” IP
    â†“
å¦‚æœé…ç½®äº† ipcidrï¼š
    â”œâ”€ æ£€æŸ¥ IP æ˜¯å¦åœ¨ ipcidr åˆ—è¡¨ä¸­
    â”‚   â”œâ”€ æ˜¯ï¼šè¿”å›ç»“æœ
    â”‚   â””â”€ å¦ï¼šä½¿ç”¨ fallback_upstream é‡æ–°æŸ¥è¯¢
    â””â”€ æœªé…ç½® ipcidrï¼šç›´æ¥è¿”å›ç»“æœ
    â†“
å¦‚æœé…ç½®äº† outputï¼š
    â””â”€ å°†åŸŸåè¿½åŠ åˆ°è¾“å‡ºæ–‡ä»¶
    â†“
è¿”å›æŸ¥è¯¢ç»“æœ
```

### ä½¿ç”¨ç¤ºä¾‹

```yaml
# å®šä¹‰ IP CIDR åˆ—è¡¨
lists:
  china_ips:
    type: "ipcidr"
    path: "./lists/china_ips.txt"

# å®šä¹‰ä¸Šæ¸¸
upstreams:
  ali_dns:
    addr: "https://dns.alidns.com/dns-query"
  google_dns:
    addr: "https://dns.google/dns-query"

# å®šä¹‰è§„åˆ™
rules:
  main:
    - direct,ali_dns
    - proxy,google_dns
  
  # Final è§„åˆ™
  final:
    primary_upstream: "ali_dns"
    fallback_upstream: "google_dns"
    ipcidr: "china_ips"
    output: "./output/unclassified_domains.txt"
```

**æŸ¥è¯¢ `unknown.com`ï¼ˆæœªåœ¨ direct/proxy åˆ—è¡¨ä¸­ï¼‰**ï¼š
```
1. ä½¿ç”¨ ali_dns æŸ¥è¯¢ â†’ è·å– IP: 203.0.113.5
2. æ£€æŸ¥ IP æ˜¯å¦åœ¨ china_ips åˆ—è¡¨ä¸­
   â”œâ”€ æ˜¯ CN IP â†’ è¿”å›ç»“æœ
   â””â”€ ä¸æ˜¯ CN IP â†’ ä½¿ç”¨ google_dns é‡æ–°æŸ¥è¯¢ â†’ è¿”å›æ–°ç»“æœ
3. å°† unknown.com è¿½åŠ åˆ° ./output/unclassified_domains.txt
```

---

## è§„åˆ™å‘½ä¸­è¿½è¸ª

### åŠŸèƒ½è¯´æ˜

å½“æŸä¸ªè§„åˆ™åŒ¹é…æˆåŠŸåï¼Œå‘½ä¸­çš„åŸŸåä¼šè¿½åŠ åˆ°è¯¥è§„åˆ™ä½¿ç”¨çš„åˆ—è¡¨çš„ `.hit.txt` æ–‡ä»¶ä¸­ã€‚

### æ–‡ä»¶å‘½åè§„åˆ™

```
åŸæ–‡ä»¶ï¼š./lists/china_domains.txt
å‘½ä¸­æ–‡ä»¶ï¼š./lists/china_domains.hit.txt
```

### é‡è¦è¯´æ˜

- å¦‚æœåˆ—è¡¨æ–‡ä»¶è·¯å¾„å·²åŒ…å« `.hit.`ï¼ˆå¦‚ `domains.hit.txt`ï¼‰ï¼Œåˆ™ä¸ä¼šå†åˆ›å»º hit æ–‡ä»¶
- æ¯è¡Œä¸€ä¸ªåŸŸåï¼ˆçº¯åŸŸåï¼‰
- `servers` ç»„ä¸è®°å½•å‘½ä¸­ï¼ˆä¸äº§ç”Ÿ .hit.txtï¼‰

### ç¤ºä¾‹

**é…ç½®**ï¼š
```yaml
lists:
  china_domains:
    type: "domain"
    path: "./lists/china_domains.txt"

rules:
  main:
    - china_domains,ali_dns
```

**æŸ¥è¯¢ `www.baidu.com`ï¼ˆåœ¨ china_domains åˆ—è¡¨ä¸­ï¼‰**ï¼š
```
1. åŒ¹é…åˆ°è§„åˆ™ï¼šchina_domains â†’ ali_dns
2. è¿½åŠ åˆ°æ–‡ä»¶ï¼š./lists/china_domains.hit.txt
   å†…å®¹ï¼šwww.baidu.com
```

**å‘½ä¸­æ–‡ä»¶ç¤ºä¾‹**ï¼š
```text
# china_domains.hit.txt
www.baidu.com
api.qq.com
example.com
test.cn
```

### ç”¨é€”

- ğŸ“Š åˆ†æé«˜é¢‘æŸ¥è¯¢åŸŸå
- ğŸ” è¯†åˆ«åº”è¯¥æ·»åŠ åˆ°è§„åˆ™çš„æ–°åŸŸå
- ğŸ“ˆ è¯„ä¼°ä¸åŒè§„åˆ™çš„ç”Ÿæ•ˆæƒ…å†µ
- âš™ï¸ ä¼˜åŒ–è§„åˆ™é…ç½®

---

## é…ç½®ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåŸºæœ¬è§„åˆ™

```yaml
# åŸŸååˆ—è¡¨
lists:
  direct:
    type: "domain"
    path: "./lists/direct.txt"
  
  proxy:
    type: "domain"
    path: "./lists/proxy.txt"

# ä¸Šæ¸¸ DNS
upstreams:
  ali:
    addr: "https://dns.alidns.com/dns-query"
  google:
    addr: "https://dns.google/dns-query"

# è§„åˆ™
rules:
  main:
    - direct,ali        # ç›´è¿åŸŸå â†’ é˜¿é‡Œ DNS
    - proxy,google      # ä»£ç†åŸŸå â†’ Google DNS
```

### ç¤ºä¾‹ 2ï¼šå¤šè§„åˆ™ç»„

```yaml
rules:
  # è§„åˆ™ç»„ 1ï¼šå®‰å…¨é˜²æŠ¤ï¼ˆæœ€å…ˆæ£€æŸ¥ï¼‰
  security:
    - ads,blocked       # å¹¿å‘Š â†’ æ‹¦æˆª
    - malware,blocked   # æ¶æ„è½¯ä»¶ â†’ æ‹¦æˆª
  
  # è§„åˆ™ç»„ 2ï¼šå›½å†…åˆ†æµï¼ˆæ¬¡æ£€æŸ¥ï¼‰
  domestic:
    - direct,ali        # å›½å†…åŸŸå â†’ é˜¿é‡Œ DNS
  
  # è§„åˆ™ç»„ 3ï¼šå›½é™…åˆ†æµï¼ˆæœ€åæ£€æŸ¥ï¼‰
  international:
    - proxy,google      # å›½é™…åŸŸå â†’ Google DNS
```

### ç¤ºä¾‹ 3ï¼šç›‘å¬å™¨è§„åˆ™

```yaml
# ç›‘å¬å™¨é…ç½®
listener:
  main: 5353
  backup: 5354
  test: 5355

# è§„åˆ™
rules:
  # åŸŸåè§„åˆ™ç»„ï¼ˆæ‰€æœ‰ç›‘å¬å™¨å…±äº«ï¼‰
  main:
    - direct,ali
    - proxy,google
  
  # ç›‘å¬å™¨è§„åˆ™ç»„ï¼ˆé’ˆå¯¹ç‰¹å®šç›‘å¬å™¨ï¼‰
  servers:
    - main,ali          # main ç›‘å¬å™¨ä½¿ç”¨ ali
    - backup,google     # backup ç›‘å¬å™¨ä½¿ç”¨ google
    - test,cloudflare   # test ç›‘å¬å™¨ä½¿ç”¨ cloudflare
```

### ç¤ºä¾‹ 4ï¼šFinal è§„åˆ™

```yaml
lists:
  direct:
    type: "domain"
    path: "./lists/direct.txt"
  
  proxy:
    type: "domain"
    path: "./lists/proxy.txt"
  
  china_ips:
    type: "ipcidr"
    path: "./lists/china_ips.txt"

upstreams:
  ali:
    addr: "https://dns.alidns.com/dns-query"
  google:
    addr: "https://dns.google/dns-query"

rules:
  main:
    - direct,ali
    - proxy,google
  
  final:
    primary_upstream: "ali"
    fallback_upstream: "google"
    ipcidr: "china_ips"
    output: "./output/unclassified.txt"
```

### ç¤ºä¾‹ 5ï¼šå¤æ‚è§„åˆ™ï¼ˆä¼˜å…ˆçº§ç¤ºä¾‹ï¼‰

```yaml
lists:
  # å…¬å¸å†…éƒ¨åŸŸå
  internal:
    type: "domain"
    domains:
      - company.com
      - internal.local
  
  # å›½å†…åŸŸå
  cn_domains:
    type: "domain"
    path: "./lists/cn.txt"
  
  # ä»£ç†åŸŸå
  proxy_domains:
    type: "domain"
    path: "./lists/proxy.txt"
  
  # å¹¿å‘ŠåŸŸå
  ads:
    type: "domain"
    path: "./lists/ads.txt"

upstreams:
  internal_dns:
    addr: "udp://192.168.1.1:53"
  ali:
    addr: "https://dns.alidns.com/dns-query"
  google:
    addr: "https://dns.google/dns-query"
  blocked:
    addr: "udp://127.0.0.1:1"

rules:
  # ç¬¬1ä¼˜å…ˆï¼šå…¬å¸å†…éƒ¨ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
  internal_trust:
    - internal,internal_dns
  
  # ç¬¬2ä¼˜å…ˆï¼šå®‰å…¨é˜²æŠ¤
  security:
    - ads,blocked
  
  # ç¬¬3ä¼˜å…ˆï¼šå›½å†…åŠ é€Ÿ
  domestic:
    - cn_domains,ali
  
  # ç¬¬4ä¼˜å…ˆï¼šå›½é™…è½¬å‘
  international:
    - proxy_domains,google
  
  # ç¬¬5ä¼˜å…ˆï¼šå…œåº•è§„åˆ™
  final:
    primary_upstream: "ali"
    fallback_upstream: "google"
```

---

## å®ä¾‹æ¼”ç¤º

### é…ç½®

```yaml
lists:
  direct:
    domains:
      - baidu.com
      - qq.com
      - aliyun.com
  
  proxy:
    domains:
      - google.com
      - github.com
  
  custom:
    domains:
      - internal.company.com

upstreams:
  ali_doh:
    addr: "https://dns.alidns.com/dns-query"
  
  google_doq:
    addr: "quic://dns.google:784"
  
  cloudflare_dot:
    addr: "tls://1.1.1.1:853"

rules:
  # è§„åˆ™ç»„ 1ï¼šå›½å†…è§„åˆ™ï¼ˆæœ€å…ˆæ£€æŸ¥ï¼‰
  domestic:
    - direct,ali_doh          # è§„åˆ™0
    - custom,cloudflare_dot   # è§„åˆ™1
  
  # è§„åˆ™ç»„ 2ï¼šå›½é™…è§„åˆ™ï¼ˆåæ£€æŸ¥ï¼‰
  international:
    - proxy,google_doq        # è§„åˆ™0
```

### æ¡ˆä¾‹ 1ï¼šç²¾ç¡®åŒ¹é… + æ·±åº¦ä¼˜å…ˆ

**æŸ¥è¯¢**ï¼š`api.aliyun.com`

**è§„åˆ™ç»„ `domestic` çš„è¯„ä¼°**ï¼š
- è§„åˆ™0 `direct,ali_doh`ï¼š
  - `baidu.com` âœ— ä¸åŒ¹é…
  - `qq.com` âœ— ä¸åŒ¹é…  
  - `aliyun.com` âœ“ åŒ¹é…ï¼Œæ·±åº¦=2
  
- è§„åˆ™1 `custom,cloudflare_dot`ï¼š
  - `internal.company.com` âœ— ä¸åŒ¹é…

**ç»„å†…ç»“æœ**ï¼šé€‰æ‹©è§„åˆ™0 (aliyun.com, æ·±åº¦=2)

**è¿”å›**ï¼š`ali_doh` (https://dns.alidns.com/dns-query)

---

### æ¡ˆä¾‹ 2ï¼šæ·±åº¦ç›¸åŒ + åè€…ä¼˜å…ˆ

**æŸ¥è¯¢**ï¼š`internal.company.com`

å‡è®¾é…ç½®æ”¹ä¸ºï¼š
```yaml
rules:
  domestic:
    - direct,ali_doh           # è§„åˆ™0ï¼šå¦‚æœ direct åŒ…å« internal.company.com
    - custom,cloudflare_dot    # è§„åˆ™1ï¼šcustom ä¹ŸåŒ…å« internal.company.com
```

**è§„åˆ™ç»„ `domestic` çš„è¯„ä¼°**ï¼š
- è§„åˆ™0ï¼šæ·±åº¦=3ï¼Œindex=0
- è§„åˆ™1ï¼šæ·±åº¦=3ï¼Œindex=1 â† **é€‰ä¸­**ï¼ˆæ·±åº¦ç›¸åŒï¼Œåè€…ä¼˜å…ˆï¼‰

**è¿”å›**ï¼š`cloudflare_dot` (tls://1.1.1.1:853)

---

### æ¡ˆä¾‹ 3ï¼šå¤šè§„åˆ™ç»„ + ç¬¬ä¸€ç»„ä¼˜å…ˆ

**æŸ¥è¯¢**ï¼š`google.com`

**è§„åˆ™å¤„ç†é¡ºåº**ï¼ˆå®Œå…¨æŒ‰ YAML å®šä¹‰é¡ºåºï¼‰ï¼š

1. **è§„åˆ™ç»„ `domestic`** (ç¬¬1ä¸ª)ï¼š
   - æ‰€æœ‰è§„åˆ™éƒ½ä¸åŒ¹é… âœ—
   - ç»§ç»­åˆ°ä¸‹ä¸€ä¸ªè§„åˆ™ç»„

2. **è§„åˆ™ç»„ `international`** (ç¬¬2ä¸ª)ï¼š
   - è§„åˆ™0 `proxy,google_doq`ï¼š
     - `google.com` âœ“ åŒ¹é…ï¼Œæ·±åº¦=2

**è¿”å›**ï¼š`google_doq` (quic://dns.google:784)

---

### æ¡ˆä¾‹ 4ï¼šçŸ­è·¯é€»è¾‘ç¤ºä¾‹

**æŸ¥è¯¢**ï¼š`ads.example.com`

**é…ç½®**ï¼š
```yaml
rules:
  security:
    - ads,blocker
  
  domestic:
    - direct,local_dns
  
  international:
    - proxy,overseas_dns
```

**æ‰§è¡Œè¿‡ç¨‹**ï¼š
```
1. æ£€æŸ¥ security group
   â”œâ”€ ads list ä¸­æœ‰ ads.example.com? âœ“ æ˜¯ï¼
   â”œâ”€ è¿”å› blocker upstream
   â””â”€ ã€åœæ­¢ã€‘â† ä¸å†æ£€æŸ¥ domestic å’Œ international
```

**ç»“æœ**ï¼šä½¿ç”¨ `blocker` ä¸Šæ¸¸ï¼Œå°½ç®¡ `direct` å’Œ `proxy` åˆ—è¡¨ä¸­ä¹Ÿå¯èƒ½æœ‰åŒ¹é…

---

## æœ€ä½³å®è·µ

### 1. è§„åˆ™ç»„æ’åº

âœ… **æ¨è**ï¼š
- é«˜ä¼˜å…ˆçº§è§„åˆ™ç»„æ”¾åœ¨å‰é¢
- æŒ‰é‡è¦æ€§æ’åºï¼šå®‰å…¨ â†’ å†…éƒ¨ â†’ å›½å†… â†’ å›½é™…
- ä½¿ç”¨æœ‰æ„ä¹‰çš„è§„åˆ™ç»„åç§°

**ç¤ºä¾‹**ï¼š
```yaml
rules:
  internal_trust:     # ç¬¬1ä¼˜å…ˆï¼šå†…éƒ¨å¯ä¿¡
    - internal,internal_dns
  
  security:           # ç¬¬2ä¼˜å…ˆï¼šå®‰å…¨é˜²æŠ¤
    - ads,blocker
    - malware,blocker
  
  domestic:           # ç¬¬3ä¼˜å…ˆï¼šå›½å†…åˆ†æµ
    - cn_domains,ali
  
  international:      # ç¬¬4ä¼˜å…ˆï¼šå›½é™…åˆ†æµ
    - global_domains,google
```

âŒ **ä¸æ¨è**ï¼š
- éšæœºæ’åºè§„åˆ™ç»„
- ä½¿ç”¨æ•°å­—å‘½åï¼ˆgroup1ã€group2ï¼‰
- æ‰€æœ‰è§„åˆ™æ”¾åœ¨ä¸€ä¸ªç»„

### 2. åŸŸååˆ—è¡¨ç®¡ç†

âœ… **æ¨è**ï¼š
- å®šæœŸæ›´æ–°åŸŸååˆ—è¡¨
- ä½¿ç”¨ `.hit.txt` åˆ†æé«˜é¢‘åŸŸå
- å°†é«˜é¢‘åŸŸåæ·»åŠ åˆ°åˆ—è¡¨
- å®šæœŸæ¸…ç†æ— æ•ˆåŸŸå

âŒ **ä¸æ¨è**ï¼š
- é•¿æœŸä¸æ›´æ–°åˆ—è¡¨
- å¿½ç•¥ `.hit.txt` æ–‡ä»¶
- åˆ—è¡¨åŒ…å«é‡å¤åŸŸå

### 3. Final è§„åˆ™ä½¿ç”¨

âœ… **æ¨è**ï¼š
- ä¸ºæœªåˆ†ç±»åŸŸåé…ç½® Final è§„åˆ™
- ä½¿ç”¨ ipcidr è¿›è¡Œæ™ºèƒ½åˆ¤å®š
- å¯ç”¨ output è®°å½•æœªåˆ†ç±»åŸŸå
- å®šæœŸåˆ†æ output æ–‡ä»¶ä¼˜åŒ–è§„åˆ™

âŒ **ä¸æ¨è**ï¼š
- ä¸é…ç½® Final è§„åˆ™ï¼ˆæŸ¥è¯¢å¤±è´¥ï¼‰
- ä¸åˆ†ææœªåˆ†ç±»åŸŸå

### 4. ç›‘å¬å™¨è§„åˆ™

âœ… **æ¨è**ï¼š
- ä¸ºä¸åŒç›‘å¬å™¨é…ç½®ä¸åŒä¸Šæ¸¸
- ä½¿ç”¨ `servers` è§„åˆ™ç»„ç®¡ç†
- ä¿æŒè§„åˆ™ç®€æ´

**ç¤ºä¾‹**ï¼š
```yaml
rules:
  # åŸŸåè§„åˆ™ï¼ˆå…±äº«ï¼‰
  main:
    - direct,ali
    - proxy,google
  
  # ç›‘å¬å™¨è§„åˆ™ï¼ˆç‹¬ç«‹ï¼‰
  servers:
    - main,ali
    - backup,google
    - test,cloudflare
```

âŒ **ä¸æ¨è**ï¼š
- æ‰€æœ‰ç›‘å¬å™¨ä½¿ç”¨ç›¸åŒä¸Šæ¸¸
- è¿‡åº¦å¤æ‚çš„ç›‘å¬å™¨è§„åˆ™

### 5. è§„åˆ™æµ‹è¯•

âœ… **æ¨è**ï¼š
- æµ‹è¯•å¸¸ç”¨åŸŸåçš„åŒ¹é…ç»“æœ
- éªŒè¯è§„åˆ™ç»„é¡ºåº
- æ£€æŸ¥æ—¥å¿—ç¡®è®¤åŒ¹é…è¿‡ç¨‹
- ä½¿ç”¨ä¸åŒç›‘å¬å™¨æµ‹è¯•

**æµ‹è¯•æ–¹æ³•**ï¼š
```bash
# æµ‹è¯•æŸ¥è¯¢
nslookup google.com 127.0.0.1 -port=5353

# æŸ¥çœ‹æ—¥å¿—
grep "åŒ¹é…è§„åˆ™" logs/creskyDNS.log

# åˆ†æå‘½ä¸­æ–‡ä»¶
cat ./lists/direct.hit.txt
```

### 6. æ€§èƒ½ä¼˜åŒ–

âœ… **æ¨è**ï¼š
- é«˜é¢‘åŸŸåæ”¾åœ¨ä¼˜å…ˆçº§é«˜çš„è§„åˆ™ç»„
- ä½¿ç”¨è§„åˆ™ç¼“å­˜åŠ é€ŸæŸ¥è¯¢
- å¯ç”¨ DNS ç¼“å­˜
- å®šæœŸä¼˜åŒ–è§„åˆ™é¡ºåº

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šåŸŸåæœªåŒ¹é…åˆ°è§„åˆ™

**ç—‡çŠ¶**ï¼š
```log
ERROR: åŸŸå example.com æœªåŒ¹é…åˆ°ä»»ä½•è§„åˆ™
```

**æ£€æŸ¥æ­¥éª¤**ï¼š
1. ç¡®è®¤åŸŸååœ¨åˆ—è¡¨æ–‡ä»¶ä¸­
2. æ£€æŸ¥åˆ—è¡¨æ–‡ä»¶æ ¼å¼
3. ç¡®è®¤è§„åˆ™é…ç½®æ­£ç¡®
4. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤åŠ è½½çŠ¶æ€

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ·»åŠ åŸŸååˆ°åˆ—è¡¨
- é…ç½® Final è§„åˆ™ä½œä¸ºå…œåº•
- æ£€æŸ¥æ–‡ä»¶ç¼–ç ï¼ˆUTF-8ï¼‰

### é—®é¢˜ 2ï¼šè§„åˆ™é¡ºåºä¸ç¬¦åˆé¢„æœŸ

**ç—‡çŠ¶**ï¼šä½ä¼˜å…ˆçº§è§„åˆ™å…ˆåŒ¹é…

**åŸå› **ï¼šè§„åˆ™ç»„é¡ºåºé”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```yaml
# âœ— é”™è¯¯ï¼šä½ä¼˜å…ˆçº§åœ¨å‰
rules:
  international:
    - proxy,google
  
  domestic:
    - direct,ali

# âœ“ æ­£ç¡®ï¼šé«˜ä¼˜å…ˆçº§åœ¨å‰
rules:
  domestic:
    - direct,ali
  
  international:
    - proxy,google
```

### é—®é¢˜ 3ï¼šè§„åˆ™ä¸ç”Ÿæ•ˆ

**æ£€æŸ¥æ¸…å•**ï¼š
1. æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
2. åˆ—è¡¨æ˜¯å¦æˆåŠŸåŠ è½½ï¼ˆæŸ¥çœ‹æ—¥å¿—ï¼‰
3. è§„åˆ™è¯­æ³•æ˜¯å¦æ­£ç¡®
4. ä¸Šæ¸¸åç§°æ˜¯å¦å­˜åœ¨
5. æ˜¯å¦éœ€è¦é‡æ–°åŠ è½½

---

## ç›¸å…³æ–‡æ¡£

- [01-LOG.md](01-LOG.md) - æ—¥å¿—æ¨¡å—
- [02-LISTENER.md](02-LISTENER.md) - ç›‘å¬å™¨æ¨¡å—
- [03-CACHE.md](03-CACHE.md) - ç¼“å­˜æ¨¡å—
- [04-UPSTREAMS.md](04-UPSTREAMS.md) - ä¸Šæ¸¸æœåŠ¡å™¨æ¨¡å—
- [05-LISTS.md](05-LISTS.md) - åˆ—è¡¨æ¨¡å—
