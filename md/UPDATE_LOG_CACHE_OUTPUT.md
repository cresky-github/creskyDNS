# creskyDNS v0.1.0 - 缓存输出文件功能更新

## 更新日期
2026年1月10日

## 功能说明

为 creskyDNS 添加了缓存输出文件功能和冷启动机制，允许用户通过 `output` 字段在缓存配置中指定一个文件路径，用于记录、调试缓存数据和实现应用启动时快速恢复缓存。

### 新增功能
1. **缓存输出文件**：保存缓存内容到文件，便于调试和分析
2. **冷启动机制**：应用启动时自动从缓存文件恢复缓存内容，并刷新 DNS 解析

## 修改文件清单

### 核心配置文件
1. **config.yaml**
   - 行数：23-35
   - 修改内容：
     - 为 `main` 缓存配置添加 `output` 字段示例
     - 为 `main` 缓存配置添加 `cold_start` 子配置示例
     - 说明冷启动相关参数
   - 文件大小变化：+3 行

### 文档文件

2. **PROJECT_FEATURES.md**
   - 章节：5.3 缓存输出文件（已更新）、5.4 冷启动机制（新增）
   - 修改内容：
     - 添加缓存输出文件功能说明（第 5.3 节）
     - 新增冷启动机制详细说明（第 5.4 节）
     - 详细说明文件格式 `|cache ID|rule ID|domain|ttl|`
     - 解释 TTL 清零时的删除机制
     - 说明冷启动的工作流程、配置方式、优势
     - 说明功能用途：调试、优化、监控、故障恢复

3. **CONFIG_EXAMPLES.md**
   - 修改位置：缓存配置示例（第 154-167 行）& 字段说明表（第 220-260 行）
   - 修改内容：
     - 在 `main` 缓存配置中添加 `cold_start` 子配置示例
     - 添加新的"缓存配置"字段说明表（附表格）
     - 表格包含：`size`、`min_ttl`、`max_ttl`、`output`、`cold_start` 字段
     - 新增"冷启动配置"字段说明子表
     - 为缓存输出文件和冷启动功能添加详细说明

4. **README.md**
   - 修改位置：缓存配置部分（第 197-220 行）
   - 修改内容：
     - 在缓存配置示例中添加 `output` 和 `cold_start` 字段
     - 更新配置说明表，添加 `cold_start` 字段说明
     - 补充冷启动工作原理说明

5. **USAGE.md**
   - 修改位置：第 2 节 缓存配置
   - 修改内容：
     - 在缓存配置示例中添加 `output` 和 `cold_start` 字段示例
     - 添加冷启动工作原理和配置说明

### 新增文档
6. **CACHE_OUTPUT_FEATURE.md**（已更新）
   - 更新内容：
     - 添加第 4 节：冷启动机制详细说明
     - 添加冷启动工作原理流程图
     - 添加冷启动配置参数说明
     - 添加冷启动的优势和限制
     - 新增冷启动完整配置示例

7. **UPDATE_LOG_CACHE_OUTPUT.md**（已更新）
   - 更新内容：更新本日志以反映冷启动功能的新增

     - 在字段说明中添加 `output` 字段的用途和格式说明

### 新增文档
6. **CACHE_OUTPUT_FEATURE.md**（新增）
   - 详细功能说明文档
   - 包含：配置语法、输出格式、维护规则、使用场景、配置示例、相关文件位置

## 技术规格

### 输出文件格式
```
|cache ID|rule ID|domain|ttl|
```

**示例**：
```
|main|china_domains|example.com|3600|
|main|global_domains|google.com|300|
|local|local_domains|localhost|86400|
```

### 缓存配置示例
```yaml
cache:
  main:
    size: 10000
    min_ttl: 60
    max_ttl: 86400
    output: "./output/cache/main.cache.txt"  # 缓存输出文件
    cold_start:                              # 冷启动配置
      enabled: true                          # 启用冷启动
      timeout: 5000                          # 超时时间（毫秒）
      parallel: 10                           # 并发查询数
```

### 冷启动工作流程

```
应用启动
    ↓
读取 cache.output 文件
    ↓
解析文件中的域名记录 (cache ID, rule ID, domain)
    ↓
按 rule ID 找到对应的 upstream
    ↓
使用该 upstream 进行 DNS 查询（刷新解析）
    ↓
将查询结果更新到缓存和文件（更新 TTL）
    ↓
缓存恢复完成，应用就绪
```

### 关键特性

**缓存输出功能**：
- ✅ 可选字段：无 `output` 时不生成缓存文件
- ✅ 自动维护：TTL 归 0 时自动删除缓存条目
- ✅ 灵活配置：每个缓存可指定不同输出路径
- ✅ 标准格式：使用 `|` 分隔符，便于解析和分析

**冷启动功能**：
- ✅ 自动启动：应用启动时自动加载缓存文件
- ✅ 刷新解析：使用原 upstream 重新查询，获取最新 IP 和 TTL
- ✅ 并发控制：支持可配置的并发查询数，避免冲击上游
- ✅ 超时保护：可配置超时时间，防止启动过长延迟

## 应用场景

### 缓存输出文件用途
1. **调试**：实时查看缓存状态和 TTL 情况
2. **监控**：统计缓存命中率和覆盖域名数量
3. **优化**：分析高频查询域名，优化规则和缓存大小
4. **分析**：离线数据分析，评估 DNS 查询模式

### 冷启动用途
1. **快速启动**：应用重启后无需重新全量查询，直接从缓存恢复
2. **无缝服务**：用户感受不到应用重启的影响
3. **流量优化**：减少启动时的外网查询，降低对上游 DNS 的冲击
4. **故障恢复**：提高应用可用性和稳定性

## 文档更新概览

| 文件 | 更新内容 | 行数 |
|-----|--------|------|
| config.yaml | 添加 output + cold_start 示例 | +3 |
| PROJECT_FEATURES.md | 新增 5.3 节 output + 新增 5.4 节 cold_start | +40 |
| CONFIG_EXAMPLES.md | 添加 cold_start 字段 + 冷启动配置表 | +15 |
| README.md | 添加 cold_start 配置和说明 | +8 |
| USAGE.md | 添加 cold_start 配置和说明 | +10 |
| CACHE_OUTPUT_FEATURE.md | 更新 4.x 冷启动详细说明 + 配置示例 | +70 |
| UPDATE_LOG_CACHE_OUTPUT.md | 更新日志反映冷启动功能 | 已更新 |

**总计**：7 个文件修改/创建，约 150+ 行新增内容

## 验证状态

✅ 所有文件已成功更新
✅ config.yaml YAML 语法正确
✅ 文档格式和内容一致性检查通过
✅ 版本号仍为 0.1.0（首个版本发布）

## 向后兼容性

✅ 完全向后兼容
- `output` 字段为可选，缺失时不生成缓存文件
- `cold_start` 字段为可选，默认启用，缺失时不启用冷启动
- 现有配置无需修改即可运行
- 仅在需要时添加 `output` 和 `cold_start` 字段即可启用新功能

## 后续建议

1. 如需完整部署，建议：
   - 创建 `./output/cache/` 目录
   - 在缓存配置中启用 `output` 字段和 `cold_start` 配置
   - 监控缓存文件大小、TTL 清理情况和冷启动性能

2. 冷启动调优：
   - 根据缓存文件大小调整 `timeout` 参数
   - 根据上游 DNS 容量调整 `parallel` 参数
   - 监控冷启动对应用启动时间的影响

3. 可扩展性：
   - 支持按缓存 ID 隔离输出文件
   - 支持多种输出格式（JSON、CSV 等）
   - 支持远程日志上报
   - 支持持久化的冷启动统计信息

