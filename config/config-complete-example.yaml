# ========================================
# CreskyDNS 完整配置文件示例
# ========================================
# 此配置文件包含所有可用功能和选项的完整示例
# 适用于生产环境和复杂场景

# ========================================
# 1. 监听器配置
# ========================================
# 定义 DNS 服务监听的端口（支持多个监听器）
listener:
  main: 53          # 主监听器 - 标准DNS端口
  secondary: 5353   # 备用监听器
  test: 5454        # 测试监听器

# ========================================
# 2. 缓存配置
# ========================================
# DNS查询结果缓存配置（提升性能）
cache:
  main:
    size: 10000        # 缓存条目数量
    min_ttl: 60        # 最小TTL（秒）- 即使上游返回更小的TTL也使用此值
    max_ttl: 86400     # 最大TTL（秒）- 即使上游返回更大的TTL也限制为此值
  
  secondary:
    size: 5000         # 较小的缓存
    min_ttl: 30
    max_ttl: 43200

# ========================================
# 3. 域名列表配置
# ========================================
# 定义各种域名列表（用于规则匹配）
lists:
  # 中国大陆域名列表
  china_domains:
    type: direct           # 类型标识
    format: text           # 文件格式：text
    path: ./lists/china_domains.txt
    interval: 300          # 热重载间隔（秒）：0=立即重载，>0=定时检查

  # 国际域名列表
  global_domains:
    type: proxy
    format: text
    path: ./lists/global_domains.txt
    interval: 600          # 10分钟检查一次更新

  # 广告拦截域名列表
  adblock_domains:
    type: block
    format: text
    path: ./lists/adblock_domains.txt
    interval: 3600         # 1小时检查一次

  # 自定义域名列表（内联方式）
  custom_domains:
    type: custom
    format: text
    domains:               # 直接在配置中定义域名
      - example.com
      - test.local
      - internal.corp
    interval: 0

  # 远程域名列表（支持URL）
  remote_list:
    type: proxy
    format: text
    url: https://example.com/domains.txt
    interval: 86400        # 每天更新一次

  # 支持通配符的域名列表
  wildcard_domains:
    type: direct
    format: text
    path: ./lists/wildcards.txt
    interval: 0
    # 文件内容示例：
    # *.cn
    # *.google.com
    # keyword:baidu

  # IPv4/IPv6 CIDR列表
  china_ip_cidr:
    type: ipcidr
    format: text
    path: ./lists/china_ip.txt
    interval: 86400
    # 文件内容示例：
    # 1.0.1.0/24
    # 2001:db8::/32

# ========================================
# 4. 上游DNS服务器配置
# ========================================
# 定义各类上游DNS服务器
upstreams:
  # 国内DNS（电信）
  china_telecom:
    addresses:
      - udp://114.114.114.114:53
      - udp://114.114.115.115:53

  # 国内DNS（阿里云）
  china_ali:
    addresses:
      - udp://223.5.5.5:53
      - udp://223.6.6.6:53
      - tcp://223.5.5.5:53       # 支持TCP

  # 国内DNS（腾讯DNSPod）
  china_dnspod:
    addresses:
      - udp://119.29.29.29:53
      - https://doh.pub/dns-query  # DoH支持

  # 国际DNS（Google）
  google_dns:
    addresses:
      - udp://8.8.8.8:53
      - udp://8.8.4.4:53
      - tcp://8.8.8.8:53
      - https://dns.google/dns-query        # DoH
      - tls://dns.google:853                # DoT

  # 国际DNS（Cloudflare）
  cloudflare_dns:
    addresses:
      - udp://1.1.1.1:53
      - udp://1.0.0.1:53
      - https://cloudflare-dns.com/dns-query  # DoH
      - tls://1.1.1.1:853                     # DoT

  # 国际DNS（Quad9 - 安全过滤）
  quad9_dns:
    addresses:
      - udp://9.9.9.9:53
      - https://dns.quad9.net/dns-query

  # 本地DNS（用于企业内网）
  local_dns:
    addresses:
      - udp://192.168.1.1:53

  # 拦截用（返回空结果）
  block_dns:
    addresses:
      - udp://127.0.0.1:9999   # 不存在的服务，实现拦截效果

# ========================================
# 5. 规则配置（按优先级顺序）
# ========================================
# 规则组按YAML顺序执行，匹配即返回
# 注意：
# - 若列表文件路径已包含 .hit.，则不会再创建 hit 文件
# - servers 组不记录命中文件
rules:
  # ----------------------------------------
  # 规则组1: 服务器/监听器特定规则
  # ----------------------------------------
  servers:
    - test:local_dns        # test监听器 → 本地DNS

  # ----------------------------------------
  # 规则组2: 广告拦截规则（最高优先级）
  # ----------------------------------------
  block:
    - adblock_domains:block_dns

  # ----------------------------------------
  # 规则组3: 自定义域名规则
  # ----------------------------------------
  custom:
    - custom_domains:local_dns
    - wildcard_domains:china_ali

  # ----------------------------------------
  # 规则组4: 主要分流规则
  # ----------------------------------------
  # 命中后会追加到对应列表的 .hit.txt 文件
  main:
    - china_domains:china_telecom     # 中国域名 → 电信DNS
    - global_domains:cloudflare_dns   # 国际域名 → Cloudflare
    - china_ip_cidr:china_dnspod      # 按IP CIDR匹配

  # ----------------------------------------
  # 规则组5: 远程列表规则
  # ----------------------------------------
  remote:
    - remote_list:google_dns

  # ----------------------------------------
  # 规则组6: 默认规则（兜底）
  # ----------------------------------------
  # 如果所有规则都不匹配，使用此规则
  default:
    - "*:google_dns"        # 所有未匹配域名 → Google DNS

# ========================================
# 6. 全局配置
# ========================================
# 请求超时时间（秒）
timeout_secs: 5

# ========================================
# 配置说明
# ========================================
# 
# 1. 域名匹配规则：
#    - 精确匹配：example.com
#    - 后缀匹配：.example.com（匹配 sub.example.com）
#    - 通配符：*.example.com（仅匹配一级子域名）
#    - 关键词：keyword:baidu（包含baidu的域名）
#    - 正则表达式：regex:^test.*\.com$
#
# 2. IP CIDR 匹配：
#    - IPv4: 1.0.1.0/24
#    - IPv6: 2001:db8::/32
#
# 3. 上游DNS协议支持：
#    - UDP: udp://8.8.8.8:53
#    - TCP: tcp://8.8.8.8:53
#    - DoH: https://dns.google/dns-query
#    - DoT: tls://dns.google:853
#    - DoQ: quic://dns.adguard.com
#    - H3:  h3://dns.google/dns-query
#
# 4. 域名列表热重载：
#    - interval: 0  → 文件改变立即重载
#    - interval: >0 → 定时检查（秒）
#
# 5. 命中文件追踪：
#    - 格式：原文件名.hit.txt
#    - 示例：china_domains.txt → china_domains.hit.txt
#    - 若路径已含 .hit.，则不再创建（避免循环）
#    - servers 组不生成 .hit.txt
#
# 6. 缓存机制：
#    - DNS Cache: 缓存查询结果
#    - Rule Cache: 缓存规则匹配结果（内存）
#    - 重载列表时自动清空 Rule Cache
#
# 7. 规则匹配顺序：
#    - Rule Cache（命中直接返回）
#    - DNS Cache（命中返回缓存）
#    - 按规则组顺序匹配
#    - 同组内按域名深度排序
#    - 匹配成功写入 Rule Cache
#
# 8. 性能优化：
#    - 支持百万级域名列表（毫秒级加载）
#    - 微秒级查询性能
#    - 内存优化的数据结构
#    - 智能缓存策略
#
# ========================================
# 使用示例
# ========================================
#
# 启动服务：
#   ./creskyDNS config-complete-example.yaml
#
# 测试查询：
#   nslookup google.com 127.0.0.1
#   dig @127.0.0.1 baidu.com
#
# 重载配置（无需重启）：
#   - 修改域名列表文件
#   - 根据 interval 设置自动重载
#
# 查看命中记录：
#   cat ./lists/china_domains.hit.txt
#   sort ./lists/china_domains.hit.txt | uniq -c | sort -nr
#
# ========================================
# 最佳实践
# ========================================
#
# 1. 生产环境建议：
#    - 使用多个上游DNS实现冗余
#    - 合理设置缓存大小和TTL
#    - 定期分析 .hit.txt 优化规则
#    - 使用 DoH/DoT 保护隐私
#
# 2. 性能优化：
#    - 按访问频率排序规则
#    - 高频域名放在前面的规则组
#    - 合理设置 interval 避免频繁重载
#
# 3. 安全建议：
#    - 启用广告拦截列表
#    - 使用加密DNS（DoH/DoT）
#    - 定期更新域名列表
#
# 4. 调试技巧：
#    - 查看日志了解匹配情况
#    - 分析 .hit.txt 文件
#    - 使用 test 监听器测试规则
#
# ========================================
