# ============================================================
# creskyDNS 完整配置示例 v0.1.0
# 包含所有功能的详细配置
# ============================================================

# 1) 日志配置（可选）
log:
  enabled: true
  path: "./logs/creskyDNS.log"
  level: "info"                 # trace/debug/info/warn/error
  max_time: 7d                  # 日志轮转时间
  max_size: 100MB               # 单文件最大大小
  max_backups: 10               # 保留备份数量
  format: "|{date}|{time}|{level}|creskyDNS|{module}|{message}|"

# 2) 监听器配置（监听端口）
listener:
  main: 5353                    # 主监听端口
  direct: 5310                  # 直连监听端口
  proxy: 5320                   # 代理监听端口

# 3) 缓存配置
cache:
  main:
    size: 10000                 # 缓存条目数量
    min_ttl: 60                 # 最小 TTL（秒）
    max_ttl: 86400              # 最大 TTL（秒）
    output: "./cache/main.cache.txt"    # 缓存输出文件（可选）
    cold_start:                 # 冷启动配置（可选）
      enabled: true             # 启用冷启动
      timeout: 5000             # 超时时间（毫秒）
      parallel: 10              # 并发查询数

  local:
    size: 1000
    min_ttl: 300
    max_ttl: 604800

# 4) 上游 DNS 配置
upstreams:
  # 国内 DNS（阿里云 DoH）
  cn_dns:
    addresses:
      - "https://dns.alidns.com/dns-query"
    bootstrap:
      - "udp://223.5.5.5"

  # 国际 DNS（Google DoH）
  global_dns:
    addresses:
      - "https://dns.google/dns-query"
    bootstrap:
      - "udp://8.8.8.8"

  # Cloudflare DoH
  cloudflare:
    addresses:
      - "https://1.1.1.1/dns-query"
    bootstrap:
      - "udp://1.1.1.1"

  # 本地 UDP DNS
  local_dns:
    addresses:
      - "udp://114.114.114.114"

  # Mihomo（代理工具）
  mihomo:
    addresses:
      - "udp://127.0.0.1:5329"

  # DNS over TLS 示例
  dot_example:
    addresses:
      - "tls://dns.google:853"

  # TCP DNS 示例
  tcp_example:
    addresses:
      - "tcp://8.8.8.8:53"

# 5) 域名列表配置
lists:
  # 预置直连列表（高优先级）
  direct.pre:
    type: "domain"
    format: "text"
    path: "/etc/creskyDNS/lists/direct.pre.txt"
    interval: 3600              # 更新间隔（秒），0 表示不自动更新

  # 预置代理列表（高优先级）
  proxy.pre:
    type: "domain"
    format: "text"
    path: "/etc/creskyDNS/lists/proxy.pre.txt"
    interval: 3600

  # 直连列表
  direct:
    type: "domain"
    format: "text"
    path: "/etc/creskyDNS/lists/direct.txt"
    url: "https://example.com/direct.txt"    # 可选，远程 URL
    interval: 86400

  # 代理列表
  proxy:
    type: "domain"
    format: "text"
    path: "/etc/creskyDNS/lists/proxy.txt"
    url: "https://example.com/proxy.txt"
    interval: 86400

  # 广告屏蔽列表
  adblock:
    type: "domain"
    format: "text"
    path: "/etc/creskyDNS/lists/adblock.txt"
    url: "https://example.com/adblock.txt"
    interval: 86400

  # 中国 IP CIDR 列表（用于 Final 规则）
  china_ips:
    type: "ipcidr"
    format: "text"
    path: "/etc/creskyDNS/ipset/china.ipset"
    interval: 604800            # 每周更新一次
    # CIDR 列表格式: |CIDR|country_code|
    # 例如: |1.0.1.0/24|CN|

# 6) 规则配置
rules:
  # 服务器监听器规则（可选）
  # 根据监听器实例匹配上游
  servers:
    - direct,cn_dns             # direct 监听器使用国内 DNS
    - proxy,mihomo              # proxy 监听器使用代理 DNS

  # 预置规则（高优先级）
  pre:
    - direct.pre,cn_dns         # 预置直连域名
    - proxy.pre,mihomo          # 预置代理域名

  # 主规则
  main:
    - adblock,local_dns         # 广告域名（可返回 NXDOMAIN）
    - direct,cn_dns             # 直连域名使用国内 DNS
    - proxy,mihomo              # 代理域名使用代理 DNS

  # Final 规则（未匹配任何规则时触发）
  # 基于 IP 地理位置智能选择上游
  final:
    primary_upstream: "cn_dns"          # 第一次查询用国内 DNS
    fallback_upstream: "mihomo"         # 若非 CN 用代理 DNS 再查
    ipcidr: "china_ips"                 # 指定 IP CIDR 列表名称
    output: "/etc/creskyDNS/output/uncategorized.txt"  # 记录未分类域名

# ============================================================
# 配置说明
# ============================================================

# 1. 监听器 (listener)
#    - 定义 DNS 服务监听的端口
#    - 同时支持 UDP 和 TCP 协议
#    - IPv4 和 IPv6 自动支持

# 2. 缓存 (cache)
#    - 两级缓存：rule.cache 和 domain.cache
#    - rule.cache 格式: |google.com|upstream_google|
#    - domain.cache 格式: |cache_id|google.com|www.google.com|ttl|IP...|
#    - 通过匹配域名（rule）关联

# 3. 上游 DNS (upstreams)
#    - 支持协议: UDP, TCP, DoT, DoH, DoQ
#    - 格式: udp://, tcp://, tls://, https://, doq://

# 4. 域名列表 (lists)
#    - domain 类型: 纯域名列表
#    - ipcidr 类型: IP CIDR 列表，格式 |CIDR|country_code|
#    - 支持本地文件和远程 URL
#    - 自动定期更新

# 5. 规则匹配顺序
#    - servers 规则（监听器匹配）
#    - pre 规则（高优先级域名）
#    - main 规则（主要域名）
#    - final 规则（智能路由）
#    - 默认上游降级

# 6. Final 规则工作原理
#    - 使用 primary_upstream 查询域名
#    - 检查返回 IP 是否在 ipcidr 列表中
#    - 若匹配 CN，使用 primary 结果
#    - 否则用 fallback_upstream 再查询
#    - 记录未分类域名到 output 文件

# 7. 域名匹配规则
#    - 按域名后缀匹配（suffix matching）
#    - 深度优先（www.google.com 优先于 google.com）
#    - 规则组顺序优先
#    - 同组内深度相同取最后一条

# 8. 日志级别
#    - trace: 最详细，包含所有调试信息
#    - debug: 调试信息
#    - info: 一般信息（推荐）
#    - warn: 警告信息
#    - error: 仅错误信息

# 9. 超时设置（全局）
timeout_secs: 5                 # DNS 查询超时时间（秒）
